"use strict";!function(){function e(e){return Array.prototype.slice.call(e)}function t(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function n(e,n,r){var o,i=new Promise(function(i,a){o=e[n].apply(e,r),t(o).then(i,a)});return i.request=o,i}function r(e,t,r){var o=n(e,t,r);return o.then(function(e){return e?new c(e,o.request):void 0})}function o(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]}})})}function i(e,t,r,o){o.forEach(function(o){o in r.prototype&&(e.prototype[o]=function(){return n(this[t],o,arguments)})})}function a(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function s(e,t,n,o){o.forEach(function(o){o in n.prototype&&(e.prototype[o]=function(){return r(this[t],o,arguments)})})}function u(e){this._index=e}function c(e,t){this._cursor=e,this._request=t}function d(e){this._store=e}function l(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)}})}function m(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new l(n)}function f(e){this._db=e}o(u,"_index",["name","keyPath","multiEntry","unique"]),i(u,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),s(u,"_index",IDBIndex,["openCursor","openKeyCursor"]),o(c,"_cursor",["direction","key","primaryKey","value"]),i(c,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(e){e in IDBCursor.prototype&&(c.prototype[e]=function(){var n=this,r=arguments;return Promise.resolve().then(function(){return n._cursor[e].apply(n._cursor,r),t(n._request).then(function(e){return e?new c(e,n._request):void 0})})})}),d.prototype.createIndex=function(){return new u(this._store.createIndex.apply(this._store,arguments))},d.prototype.index=function(){return new u(this._store.index.apply(this._store,arguments))},o(d,"_store",["name","keyPath","indexNames","autoIncrement"]),i(d,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getAllKeys","count"]),s(d,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),a(d,"_store",IDBObjectStore,["deleteIndex"]),l.prototype.objectStore=function(){return new d(this._tx.objectStore.apply(this._tx,arguments))},o(l,"_tx",["objectStoreNames","mode"]),a(l,"_tx",IDBTransaction,["abort"]),m.prototype.createObjectStore=function(){return new d(this._db.createObjectStore.apply(this._db,arguments))},o(m,"_db",["name","version","objectStoreNames"]),a(m,"_db",IDBDatabase,["deleteObjectStore","close"]),f.prototype.transaction=function(){return new l(this._db.transaction.apply(this._db,arguments))},o(f,"_db",["name","version","objectStoreNames"]),a(f,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(t){[d,u].forEach(function(n){n.prototype[t.replace("open","iterate")]=function(){var n=e(arguments),r=n[n.length-1],o=(this._store||this._index)[t].apply(this._store,n.slice(0,-1));o.onsuccess=function(){r(o.result)}}})}),[u,d].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise(function(o){n.iterateCursor(e,function(e){return e?(r.push(e.value),void 0!==t&&r.length==t?void o(r):void e["continue"]()):void o(r)})})})});var p={open:function(e,t,r){var o=n(indexedDB,"open",[e,t]),i=o.request;return i.onupgradeneeded=function(e){r&&r(new m(i.result,e.oldVersion,i.transaction))},o.then(function(e){return new f(e)})},"delete":function(e){return n(indexedDB,"deleteDatabase",[e])}};"undefined"!=typeof module?module.exports=p:self.idb=p}();var stations=[],fromValidStation=!1,toValidStation=!1,offlineMode=!1,currentJourneys=[],journey={};fetch("https://huxley.apphb.com/crs").then(function(e){return e.json()}).then(function(e){e.map(function(e){return stations.push(e.stationName)}),stations=stations.map(function(e){return e.toLowerCase()})})["catch"](function(e){document.getElementById("title").innerHTML="<span id='offline'>Offline (May not include latest updates)</span> - UK Train Times",offlineMode=!0,useCachedStationData()});var useCachedStationData=function(){fetch("/stations.json").then(function(e){return e.json()}).then(function(e){e.map(function(e){return stations.push(e.stationName)}),stations=stations.map(function(e){return e.toLowerCase()})})["catch"](function(e){console.log("NOPE NOT got the stations :(")})},departureStationLookup=function(){document.getElementById("error-message").innerHTML="",document.getElementById("departureSuggestions").innerHTML="";var e=document.getElementById("departure").value;e=e.toLowerCase(),stations.indexOf(e)>-1?(document.getElementById("departure").style.border="1px solid rgba(25, 210, 25, 0.7)",fromValidStation=!0,toValidStation&&fetchTrainTimes()):(offlineMode&&fetchTrainTimes(),document.getElementById("departure").style.border="1px solid black",fromValidStation=!1,document.getElementById("train-times").innerHTML="");var t=stations.filter(function(t){return t.match(e)});t.length<11&&t.map(function(e){return document.getElementById("departureSuggestions").innerHTML+='<div class="suggested-departure-station" name="'+e+'">'+e+"</div><br>"}),$(".suggested-departure-station").on("click",function(){document.getElementById("departure").value=this.getAttribute("name"),document.getElementById("departureSuggestions").innerHTML="",stations.indexOf(document.getElementById("departure").value)>-1?(document.getElementById("departure").style.border="1px solid rgba(25, 210, 25, 0.7)",fromValidStation=!0,toValidStation&&fetchTrainTimes()):(offlineMode&&fetchTrainTimes(),document.getElementById("departure").style.border="1px solid black",fromValidStation=!1,document.getElementById("train-times").innerHTML="")})},destinationStationLookup=function(){document.getElementById("error-message").innerHTML="",document.getElementById("destinationSuggestions").innerHTML="";var e=document.getElementById("destination").value;e=e.toLowerCase(),stations.indexOf(e)>-1?(document.getElementById("destination").style.border="1px solid rgba(25, 210, 25, 0.7)",toValidStation=!0,fromValidStation&&fetchTrainTimes()):(offlineMode&&fetchTrainTimes(),document.getElementById("destination").style.border="1px solid black",toValidStation=!1,document.getElementById("train-times").innerHTML="");var t=stations.filter(function(t){return t.match(e)});t.length<11&&t.map(function(e){return document.getElementById("destinationSuggestions").innerHTML+='<div class="suggested-destination-station" name="'+e+'">'+e+"</div><br>"}),$(".suggested-destination-station").on("click",function(){document.getElementById("destination").value=this.getAttribute("name"),document.getElementById("destinationSuggestions").innerHTML="",stations.indexOf(document.getElementById("destination").value)>-1?(document.getElementById("destination").style.border="1px solid rgba(25, 210, 25, 0.7)",toValidStation=!0,fromValidStation&&fetchTrainTimes()):(offlineMode&&fetchTrainTimes(),document.getElementById("destination").style.border="1px solid black",toValidStation=!1,document.getElementById("train-times").innerHTML="")})},fetchTrainTimes=function(){var e=document.getElementById("departure").value,t=document.getElementById("destination").value;if(e==t)document.getElementById("error-message").innerHTML="Please select different stations";else{document.getElementById("error-message").innerHTML="";var n="https://huxley.apphb.com/departures/"+e+"/to/"+t+"?accessToken=3bb783d8-9df4-4be0-98bb-c25d56f391fd";fetch(n).then(function(e){return e.json()}).then(function(e){for(var t in e.trainServices)null==e.trainServices[t].platform&&(e.trainServices[t].platform="");if(null==e.trainServices)document.getElementById("error-message").innerHTML="No trains between these stations";else{currentJourneys=[];for(var n in e.trainServices)journey={},journey.departure=e.trainServices[n].std,journey.operator=e.trainServices[n].operator,journey.platform=e.trainServices[n].platform,journey.serviceID=e.trainServices[n].serviceID,currentJourneys.push(journey);document.getElementById("error-message").innerHTML="",document.getElementById("train-times").innerHTML="<div class='train'><div class='table-row headers'><div class='table-item' >Departure</div><div class='table-item' >Arrival</div><div class='table-item' >Operator</div><div class='table-item' >Platform</div></div></div>",e.trainServices.map(function(e){return document.getElementById("train-times").innerHTML+="<div class='train'><div class='table-row'><div class='table-item'>"+e.std+"</div><div class='table-item' id='"+e.serviceID+"'>"+getArrivalTime(e.serviceID)+"</div><div class='table-item'>"+e.operator+"</div><div class='table-item'>"+e.platform+"</div></div></div>"})}})["catch"](function(e){console.log("There has been a problem with your fetch operation: "+e.message);var t=idb.open("train-times",1,function(e){});t.then(function(e){return e.transaction("trains").objectStore("trains").getAll()}).then(function(e){for(var t in e)console.log(e[t].name),e[t].name==document.getElementById("departure").value.toLowerCase()+":"+document.getElementById("destination").value.toLowerCase()&&(document.getElementById("train-times").innerHTML="<div class='train'><div class='table-row headers'><div class='table-item' >Departure</div><div class='table-item' >Arrival</div><div class='table-item' >Operator</div><div class='table-item' >Platform</div></div></div>",e[t].trains.map(function(e){return document.getElementById("train-times").innerHTML+="<div class='train'><div class='table-row'><div class='table-item'>"+e.departure+"</div><div class='table-item'>"+e.arrival+"</div><div class='table-item'>"+e.operator+"</div><div class='table-item'>"+e.platform+"</div></div></div>"}))})})}},getArrivalTime=function(e){var t="https://huxley.apphb.com/service/"+e+"?accessToken=DA1C7740-9DA0-11E4-80E6-A920340000B1",n="";fetch(t).then(function(e){return e.json()}).then(function(t){var r=t.subsequentCallingPoints[0].callingPoint.filter(function(e){return e.locationName.toLowerCase()==document.getElementById("destination").value});n=r[0].st,document.getElementById(e).innerHTML=n;for(var o in currentJourneys)currentJourneys[o].serviceID==e&&(currentJourneys[o].arrival=n);storeInIDB(currentJourneys,e)})["catch"](function(e){console.log("There has been a problem with your fetch operation: "+e.message)});return n},storeInIDB=function(e,t){var n=idb.open("train-times",1,function(e){e.createObjectStore("trains",{keyPath:"name"})});n.then(function(t){var n=t.transaction("trains","readwrite"),r=n.objectStore("trains");return r.put({name:document.getElementById("departure").value.toLowerCase()+":"+document.getElementById("destination").value.toLowerCase(),trains:e}),n.complete}).then(function(){console.log("train added"),idb.close()})};